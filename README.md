# core

# 仕様

## ISA
+ RISC-Vベース
    + RV32I (一部未実装)
    + RV32M (一部未実装)
    + RV32D (一部未実装)
    + `FROUNDRM`系(RV32Dに追加) : 浮動小数点数整数化丸め用の命令
        + `FFLOOR` : 切り捨て
    + `IN`系・`OUT`系(カスタム) : UARTによる入出力用の命令
        + `INW` : 32bit整数の入力
        + `INF` : 32bit浮動小数点数の入力
        + `OUTW` : 32bit整数の出力
        + `OUTB` : 8bit整数の出力

## データの種類
+ 命令 : 32bit
    + 形式的には16bit単位の可変長
    + 32bitのものしか使っていない
+ 整数および汎用
    + byte : 8bit
    + word : 32bit
+ 浮動小数点数
    + float : 32bit

## レジスタ
+ 32bit整数用 : 32個
    + 0番 : ゼロレジスタ
    + コンパイラの用法
        + 1番 : リンクレジスタ(caller save)
            + 0で初期化
        + 2番 : スタックポインタ(caller save)
            + メモリサイズで初期化
        + 3番 : ヒープポインタ
            + 0で初期化
        + 4番 : 返り値(caller save)
            + 0で初期化(以下すべて0)
        + 4~30番 : 引数(caller save)
        + 31番 : 一時変数(関数呼び出しで保存されない)
+ 32bit浮動小数点数用 : 32個
    + 0で初期化

## メモリ
+ 命令メモリ : 128KB
    + アドレスは32bit
        + 上位15bitは無視
    + アクセスはバイトアドレッシング
        + 1命令ごとにアドレスが4つ増える
        + PCの下位2ビットは更新時に無視する
    + 実装は32bitデータのメモリ
+ データメモリ : 2MB
    + アドレスは32bit
        + 上位11bitは無視
    + バイトアドレッシング(実際にはWord単位でのアクセスのみ実装)
    + ビッグエンディアン

## その他

+ パイプラインなし

-------------------------------

# モジュール間のタイミングの取り方

## CPU

パイプライン時のステージ間のレジスタの管理をして、下位のモジュールに指示を出すのが役割  

+ **クロックに同期して**小さな処理を開始し、
+ **そのまま**下位のモジュールに仕事を投げ、
+ 出力されたものを**クロックと同期して**受け取る

ので、下位のモジュールは、

+ cpuから送られてきた`order`を受け取ったあと、**次のクロックを待たずに処理を開始**してしまったほうが良い
+ 出力も、**最終クロックの初めに**(1クロックで終わるなら入力を認識した直後に)`done`**を上げて**、**クロックを待たずに出力する**ほうが望ましい

## メモリ

+ クロック同期でアドレスなどを読み込み、
+ そのクロックのうちに実行し、
+ 次のクロックで出力開始する

ので、アクセスするときには、

+ `order`同期の信号をそのまま送り(1クロック)、
+ 1クロック待ち(2クロック)、
+ メモリの出力とモジュールの出力をつなげる(3クロック)

## レジスタを使用する記憶用モジュール

レジスタを使うときには、

+ クロック同期で入力を代入し、
+ 出力は同期せずにできる
    + が、独立した作業をさせる場合にはクロック同期で出力するようにする

ので、`order`等を使って呼び出すときには、

+ クロックと同期せずに入力して、
+ クロックを待たずに`accepted`や`done`を確認し次第`order`を取り下げる
